<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LuxRide - Drive in Luxury</title>
    <link rel="preload" as="image" href="/images/g-class-home.jpg">
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="/css/tw.build.css">
    <link rel="stylesheet" href="/css/animatedBackground.css">
    <link rel="stylesheet" href="/css/validation.css">
    <link rel="stylesheet" href="/css/footer.css">
    <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>
<body>
    <!-- Include Navigation -->
    <%- include('partials/header') %>
    
    <%- include('partials/validationBanner') %>


    <%- include('partials/filter', { title, pickupDateISO, returnDateISO, pickupDate, returnDate }) %>
    <%
      // Safe defaults for pagination/filters when rendering from other controllers
      var currentPage = (typeof currentPage !== 'undefined' && currentPage) ? currentPage : 1;
      var totalPages  = (typeof totalPages  !== 'undefined' && totalPages)  ? totalPages  : 1;
      var category    = (typeof category    !== 'undefined' && category)    ? category    : '';
    %>
    <!-- Categories, Filters aside and pagination -->
    <section class="container fleet-layout" id="fleet" style="padding:2rem 1rem;">
      <!-- Filters aside – UI only, GET form (no new backend logic) -->
      <aside class="filters-aside">
        <div class="filters-aside-inner">
          <h3 class="filters-aside-title">Filters</h3>
          <form method="GET" action="/" class="filters-aside-form">
            <% const f = (typeof filters !== 'undefined' && filters) ? filters : {}; %>

            <div class="filters-field">
              <label for="flt-transmission">Transmission</label>
              <select id="flt-transmission" name="transmission" class="filters-select">
                <option value="">Any</option>
                <option value="automatic" <%= f.transmission === 'automatic' ? 'selected' : '' %>>Automatic</option>
                <option value="manual" <%= f.transmission === 'manual' ? 'selected' : '' %>>Manual</option>
              </select>
            </div>

            <div class="filters-field">
              <label for="flt-fuel">Fuel</label>
              <select id="flt-fuel" name="fuelType" class="filters-select">
                <option value="">Any</option>
                <option value="petrol" <%= f.fuelType === 'petrol' ? 'selected' : '' %>>Petrol</option>
                <option value="diesel" <%= f.fuelType === 'diesel' ? 'selected' : '' %>>Diesel</option>
                <option value="hybrid" <%= f.fuelType === 'hybrid' ? 'selected' : '' %>>Hybrid</option>
                <option value="electric" <%= f.fuelType === 'electric' ? 'selected' : '' %>>Electric</option>
              </select>
            </div>

            <div class="filters-row filters-row--range">
              <div class="filters-field filters-field--min-price">
                <label for="flt-price-min">Min price / day</label>
                <input id="flt-price-min" type="number" name="priceMin" min="0" class="filters-input" value="<%= f.priceMin || '' %>" />
              </div>

              <div class="filters-field filters-field--max-price">
                <label for="flt-price-max">Max price / day</label>
                <input id="flt-price-max" type="number" name="priceMax" min="0" class="filters-input" value="<%= f.priceMax || '' %>" />
              </div>
            </div>

            <div class="filters-row filters-row--range">
              <div class="filters-field filters-field--min-seats">
                <label for="flt-seats-min">Min seats</label>
                <input id="flt-seats-min" type="number" name="seatsMin" min="1" max="9" class="filters-input" value="<%= f.seatsMin || '' %>" />
              </div>

              <div class="filters-field filters-field--max-seats">
                <label for="flt-seats-max">Max seats</label>
                <input id="flt-seats-max" type="number" name="seatsMax" min="1" max="9" class="filters-input" value="<%= f.seatsMax || '' %>" />
              </div>
            </div>

            <div class="filters-field">
              <label for="flt-category">Browse by Category</label>
              <select id="flt-category" name="category" class="filters-select" onchange="this.form.submit()">
                <option value="" <%= category === '' ? 'selected' : '' %>>All</option>
                <option value="automatic" <%= category === 'automatic' ? 'selected' : '' %>>Automatic</option>
                <option value="manual" <%= category === 'manual' ? 'selected' : '' %>>Manual</option>
                <option value="electric" <%= category === 'electric' ? 'selected' : '' %>>Electric</option>
                <option value="hybrid" <%= category === 'hybrid' ? 'selected' : '' %>>Hybrid</option>
                <option value="petrol" <%= category === 'petrol' ? 'selected' : '' %>>Petrol</option>
                <option value="diesel" <%= category === 'diesel' ? 'selected' : '' %>>Diesel</option>
                <option value="seats-2-3" <%= category === 'seats-2-3' ? 'selected' : '' %>>2-3 seats</option>
                <option value="seats-4-5" <%= category === 'seats-4-5' ? 'selected' : '' %>>4-5 seats</option>
                <option value="seats-6-9" <%= category === 'seats-6-9' ? 'selected' : '' %>>6-9 seats</option>
              </select>
            </div>

            <!-- Reset to first page when applying filters -->
            <input type="hidden" name="page" value="1" />
            <button type="submit" class="filters-apply-btn">Apply</button>
          </form>
        </div>
      </aside>

      <!-- Right side: categories + cars + pagination -->
      <div class="fleet-main">
        <!-- Reuse the existing car card component as the gallery -->
        <div class="home-cars-grid">
          <%- include('partials/carCards', { cars: cars }) %>
        </div>

        <!-- Existing pagination, just wrap for styling -->
        <div class="home-pagination-bar">
          <div style="display:flex; justify-content:center; align-items:center; gap:.4rem; margin-top:0;">
            <style>
              .pager { display:flex; gap:.4rem; align-items:center; }
              .pager a { padding:.5rem .8rem; border:2px solid #ffd23f; text-decoration:none; font-weight:800; letter-spacing:.02em; }
              .pager a.active { background:#ffd23f; color:#111; }
              .pager a[disabled] { opacity:.4; pointer-events:none; }
              .pager-mobile { display:none; gap:.5rem; align-items:center; }
              .pager-mobile .status { color:#ffd23f; font-weight:800; }
              @media (max-width: 480px) {
                .pager-desktop { display:none !important; }
                .pager-mobile { display:flex; }
                .pager-mobile a { padding:.35rem .6rem; border:2px solid #ffd23f; border-radius:10px; color:#ffd23f; text-decoration:none; font-weight:800; }
              }
            </style>
            <!-- Desktop/full pager -->
            <div class="pager pager-desktop" style="display:flex; gap:.4rem; flex-wrap:nowrap;">
              <%
                function qp(k, v) {
                  if (typeof v === 'undefined' || v === null) return '';
                  const s = String(v).trim();
                  if (!s) return '';
                  return '&' + k + '=' + encodeURIComponent(s);
                }
                const q =
                  qp('category', category) +
                  qp('transmission', f.transmission) +
                  qp('fuelType', f.fuelType) +
                  qp('seatsMin', f.seatsMin) +
                  qp('seatsMax', f.seatsMax) +
                  qp('priceMin', f.priceMin) +
                  qp('priceMax', f.priceMax);
              %>
              <a class="prev" <%= currentPage>1? '':'disabled' %> href="/?page=<%= currentPage - 1 %><%= q %>" aria-label="Previous">‹</a>
              <% if (currentPage > 2) { %>
                <a class="" href="/?page=1<%= q %>">1</a>
                <% if (currentPage > 3) { %>
                  <span style="color:#ffd23f; opacity:.7; padding:0 .25rem;">…</span>
                <% } %>
              <% } %>
              <% for (var p = Math.max(1, currentPage - 1); p <= Math.min(totalPages, currentPage + 1); p++) { %>
                <% if (p === currentPage) { %>
                  <a class="active" href="/?page=<%= p %><%= q %>"><%= p %></a>
                <% } else { %>
                  <a class="" href="/?page=<%= p %><%= q %>"><%= p %></a>
                <% } %>
              <% } %>
              <% if (currentPage < totalPages - 1) { %>
                <% if (currentPage < totalPages - 2) { %>
                  <span style="color:#ffd23f; opacity:.7; padding:0 .25rem;">…</span>
                <% } %>
                <a class="" href="/?page=<%= totalPages %><%= q %>"><%= totalPages %></a>
              <% } %>
              <a class="next" <%= currentPage<totalPages? '':'disabled' %> href="/?page=<%= currentPage + 1 %><%= q %>" aria-label="Next">›</a>
            </div>
            <!-- Compact mobile pager -->
            <div class="pager-mobile">
              <% const q2 = q; %>
              <a class="prev" <%= currentPage>1? '':'disabled' %> href="/?page=<%= currentPage - 1 %><%= q2 %>">‹</a>
              <span class="status">Page <%= currentPage %> / <%= totalPages %></span>
              <a class="next" <%= currentPage<totalPages? '':'disabled' %> href="/?page=<%= currentPage + 1 %><%= q2 %>">›</a>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Include Footer -->
    <%- include('partials/footer') %>

    <!-- Include JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="/js/datePicker.js"></script>
    <script src="/js/customDropdown.js"></script>
    <script src="/js/mobileNav.js"></script>
    <script src="/js/index.js"></script>
    <script src="/js/ajaxPagination.js"></script>
</body>
</html>