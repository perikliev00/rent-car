<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %> - LuxRide</title>
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="/css/footer.css">
    <%
      function formatDate(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return dateString;
        const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        return `${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear()}`;
      }
      function formatLocation(locationString) {
        if (!locationString) return '';
        const specialCases = {
          'office': 'Office',
          'sunny-beach': 'Sunny Beach',
          'sveti-vlas': 'Sveti Vlas',
          'nesebar': 'Nesebar',
          'burgas': 'Burgas',
          'burgas-airport': 'Burgas Airport',
          'sofia': 'Sofia',
          'sofia-airport': 'Sofia Airport',
          'varna': 'Varna',
          'varna-airport': 'Varna Airport',
          'plovdiv': 'Plovdiv',
          'eleni': 'Eleni',
          'ravda': 'Ravda'
        };
        if (specialCases[locationString]) return specialCases[locationString];
        return locationString
          .split('-')
          .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
          .join(' ');
      }
      const statusMap = {
        expired: { label: 'Expired', class: 'badge badge-expired' },
        cancelled: { label: 'Cancelled', class: 'badge badge-cancelled' },
        pending: { label: 'Pending', class: 'badge badge-pending' },
        active: { label: 'Active', class: 'badge badge-active' }
      };
    %>
    <style>
      .admin-orders { padding:2rem; max-width: 1200px; margin:0 auto; }
      .page-header { display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid #ffd23f; padding-bottom:1rem; margin-bottom:1.5rem; }
      .page-title { color:#ffd23f; margin:0; }
      .orders-container { background:rgba(24,24,24,.6); border:2px solid #ffd23f; border-radius:10px; padding:1.5rem; }
      .orders-table { width:100%; border-collapse:collapse; color:#fff; }
      .orders-table th, .orders-table td { padding:0.85rem; text-align:left; border-bottom:1px solid #333; }
      .orders-table th { background:rgba(255,210,63,.1); color:#ffd23f; font-weight:600; }
      .admin-actions { display:flex; gap:0.5rem; flex-wrap:wrap; }
      .btn-admin { padding:0.45rem 0.9rem; border:1px solid; border-radius:4px; background:transparent; cursor:pointer; font-size:0.8rem; text-decoration:none; }
      .btn-edit { border-color:#3b82f6; color:#3b82f6; } .btn-edit:hover { background:#3b82f6; color:#fff; }
      .btn-delete { border-color:#ef4444; color:#ef4444; } .btn-delete:hover { background:#ef4444; color:#fff; }
      .badge { padding:0.35rem 0.8rem; border-radius:999px; font-size:0.75rem; font-weight:700; display:inline-flex; align-items:center; justify-content:center; text-transform:uppercase; letter-spacing:0.03em; }
      .badge-active { background: rgba(16,185,129,.15); color:#10b981; border:1px solid rgba(16,185,129,.4); }
      .badge-pending { background: rgba(245,158,11,.15); color:#f59e0b; border:1px solid rgba(245,158,11,.4); }
      .badge-expired { background: rgba(239,68,68,.15); color:#ef4444; border:1px solid rgba(239,68,68,.4); }
      .badge-cancelled { background: rgba(107,114,128,.2); color:#9ca3af; border:1px solid rgba(107,114,128,.4); }
      @media (max-width: 768px) {
        .admin-orders { padding:1rem; }
        .orders-table { font-size:0.85rem; }
        .orders-table th, .orders-table td { padding:0.65rem; }
        .admin-actions { flex-direction:column; }
      }
    </style>
</head>
<body>
  <%- include('../partials/header') %>
  <div class="admin-orders">
    <div class="page-header">
      <h1 class="page-title"><%= title %></h1>
      <div style="display:flex; gap:0.5rem;">
        <a href="/admin/orders" class="btn-admin" style="border-color:#ffd23f;color:#ffd23f;">← All Orders</a>
        <a href="/admin/orders/new" class="btn-admin" style="border-color:#10b981;color:#10b981;">+ Add Order</a>
      </div>
    </div>
    <div class="orders-container">
      <% if (orders && orders.length) { %>
        <div style="overflow-x:auto;">
          <table class="orders-table">
            <thead>
              <tr>
                <th>Customer</th>
                <th>Car</th>
                <th>Rental Period</th>
                <th>Locations</th>
                <th>Pricing</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <% orders.forEach(order => { %>
                <tr>
                  <td>
                    <div style="font-weight:600;color:#ffd23f;"><%= order.fullName %></div>
                    <div style="font-size:0.85rem;opacity:.75;"><%= order.email %><br><%= order.phoneNumber %></div>
                  </td>
                  <td>
                    <% if (order.carId) { %>
                      <div style="font-weight:600;"><%= order.carId.name %></div>
                      <div style="font-size:0.8rem;opacity:.75;"><%= order.carId.transmission %> • <%= order.carId.seats %> seats</div>
                    <% } else { %>
                      <span style="opacity:.5;">Car not found</span>
                    <% } %>
                  </td>
                  <td>
                    <div style="font-weight:600;"><%= formatDate(order.pickupDate) %> → <%= formatDate(order.returnDate) %></div>
                    <div style="font-size:0.8rem;opacity:.75;"><%= order.pickupTime %> - <%= order.returnTime %></div>
                  </td>
                  <td>
                    <div style="color:#10b981;">Pickup: <%= formatLocation(order.pickupLocation) %></div>
                    <div style="color:#3b82f6;">Return: <%= formatLocation(order.returnLocation) %></div>
                  </td>
                  <td>
                    <div style="font-weight:700;color:#ffd23f;">€<%= order.totalPrice %></div>
                    <div style="font-size:0.85rem;opacity:.75;"><%= order.rentalDays %> days</div>
                    <div style="font-size:0.75rem;opacity:.7;margin-top:0.25rem;">
                      Delivery €<%= order.deliveryPrice || 0 %> • Return €<%= order.returnPrice || 0 %>
                    </div>
                  </td>
                  <td>
                    <% const status = order.status || 'expired'; const meta = statusMap[status] || statusMap['expired']; %>
                    <span class="<%= meta.class %>"><%= meta.label %></span>
                  </td>
                  <td>
                    <div class="admin-actions">
                      <a class="btn-admin btn-edit" href="/admin/orders/<%= order._id %>/edit">Edit</a>
                      <form action="/admin/orders/<%= order._id %>/delete" method="POST" onsubmit="return confirm('Delete this expired order? This also removes its car dates.');">
                        <input type="hidden" name="_csrf" value="<%= csrfToken || '' %>">
                        <button type="submit" class="btn-admin btn-delete">Delete</button>
                      </form>
                    </div>
                  </td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
      <% } else { %>
        <div style="text-align:center; padding:3rem;">
          <p style="color:#fff;opacity:.7;font-size:1.1rem;">No expired orders yet.</p>
          <p style="color:#ffd23f;opacity:.85;">Completed rentals will show up here once their return time has passed.</p>
        </div>
      <% } %>
    </div>
  </div>
  <%- include('../partials/footer') %>
  <script src="/js/mobileNav.js"></script>
</body>
</html>

