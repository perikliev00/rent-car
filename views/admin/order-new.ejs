<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %></title>
  <link rel="stylesheet" href="/css/styles.css">
  <link rel="stylesheet" href="/css/footer.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <style>
    .card input, .card select { background:#0f0f0f; border:2px solid #ffd23f; color:#ffd23f; border-radius:8px; padding:.45rem .55rem; width:100%; box-sizing:border-box; }
    .card label { color:#ffd23f; font-weight:700; }
    .card input::placeholder { color:#ffd23fcc; }
    .card select:focus, .card input:focus { outline:none; box-shadow:0 0 0 2px rgba(255,210,63,.35); }
    .form-grid { display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:.75rem; }
    .row { display:flex; align-items:center; gap:.4rem; }
    .row label { min-width: 120px; font-size:.95rem; line-height:1; }
    @media (max-width: 720px) {
      .form-grid { grid-template-columns: 1fr; }
      .row label { min-width: 110px; }
    }
    @media (max-width: 360px) {
      .row label { min-width: 95px; font-size:.9rem; }
      .card input, .card select { padding:.4rem .5rem; }
    }
  </style>
</head>
<body>
  <%- include('../partials/header') %>
  <main class="admin-orders" style="max-width: 900px; margin: 2rem auto;">
    <h1 class="page-title" style="color:#ffd23f;">Add Order</h1>
    <% if (typeof error !== 'undefined' && error) { %>
      <div class="banner error" style="border:2px solid #ef4444;color:#ef4444;font-weight:800;padding:.6rem .8rem;border-radius:8px;margin:.5rem 0 1rem 0;background:rgba(239,68,68,.1)"><%= error %></div>
    <% } %>
    <form action="/admin/orders/new" method="POST" class="card" style="padding:1rem;border:2px solid #ffd23f;border-radius:10px;background:rgba(24,24,24,.6);">
      <div class="form-grid">
        <div class="row">
          <label>Pickup Date</label>
          <input type="date" name="pickupDate" value="<%= defaults.pickupDate %>" required>
        </div>
        <div class="row">
          <label>Pickup Time</label>
          <input type="time" name="pickupTime" value="<%= defaults.pickupTime %>" list="timeOptions" required>
        </div>
        <div class="row">
          <label>Return Date</label>
          <input type="date" name="returnDate" value="<%= defaults.returnDate %>" required>
        </div>
        <div class="row">
          <label>Return Time</label>
          <input type="time" name="returnTime" value="<%= defaults.returnTime %>" list="timeOptions" required>
        </div>
        <div class="row">
          <label>Pickup Location</label>
          <select name="pickupLocation">
            <option value="office" <%= defaults.pickupLocation==='office'?'selected':'' %>>Office</option>
            <option value="sunny-beach">Sunny Beach</option>
            <option value="sveti-vlas">Sveti Vlas</option>
            <option value="nesebar">Nesebar</option>
            <option value="burgas">Burgas</option>
            <option value="burgas-airport">Burgas Airport</option>
            <option value="sofia">Sofia</option>
            <option value="sofia-airport">Sofia Airport</option>
            <option value="varna">Varna</option>
            <option value="varna-airport">Varna Airport</option>
            <option value="plovdiv">Plovdiv</option>
            <option value="eleni">Eleni</option>
            <option value="ravda">Ravda</option>
          </select>
        </div>
        <div class="row">
          <label>Return Location</label>
          <select name="returnLocation">
            <option value="office" <%= defaults.returnLocation==='office'?'selected':'' %>>Office</option>
            <option value="sunny-beach">Sunny Beach</option>
            <option value="sveti-vlas">Sveti Vlas</option>
            <option value="nesebar">Nesebar</option>
            <option value="burgas">Burgas</option>
            <option value="burgas-airport">Burgas Airport</option>
            <option value="sofia">Sofia</option>
            <option value="sofia-airport">Sofia Airport</option>
            <option value="varna">Varna</option>
            <option value="varna-airport">Varna Airport</option>
            <option value="plovdiv">Plovdiv</option>
            <option value="eleni">Eleni</option>
            <option value="ravda">Ravda</option>
          </select>
        </div>
        <div class="row">
          <label>Hotel Name (optional)</label>
          <input type="text" name="hotelName" value="<%= defaults.hotelName %>" placeholder="Hotel name">
        </div>
        <div class="row">
          <label>Rental Days</label>
          <input type="number" min="1" name="rentalDays" value="<%= defaults.rentalDays %>">
        </div>
        <div class="row">
          <label>Delivery Price</label>
          <input type="number" step="0.01" name="deliveryPrice" value="<%= defaults.deliveryPrice %>">
        </div>
        <div class="row">
          <label>Return Price</label>
          <input type="number" step="0.01" name="returnPrice" value="<%= defaults.returnPrice %>">
        </div>
        <div class="row">
          <label>Total Price</label>
          <input type="number" step="0.01" name="totalPrice" value="<%= defaults.totalPrice %>">
        </div>
        <div class="row">
          <label>Car</label>
          <select name="carId" required>
            <option value="">Select car</option>
            <% (cars||[]).forEach(function(c){ %>
              <option value="<%= c._id %>"
                      data-price="<%= c.price || '' %>"
                      data-tier1_3="<%= c.priceTier_1_3 || '' %>"
                      data-tier7_31="<%= c.priceTier_7_31 || '' %>"
                      data-tier31_plus="<%= c.priceTier_31_plus || '' %>">
                <%= c.name %>
              </option>
            <% }) %>
          </select>
        </div>
        <div style="grid-column:1 / -1; border-top:1px dashed #333; padding-top:1rem; display:grid; grid-template-columns: 1fr; gap:.5rem;">
          <div class="row"><label>Full Name</label><input type="text" name="fullName" placeholder="Customer name"></div>
          <div class="row"><label>Phone Number</label><input type="text" name="phoneNumber" placeholder="Customer phone"></div>
          <div class="row"><label>Email</label><input type="email" name="email" placeholder="Customer email"></div>
          <div class="row"><label>Address</label><input type="text" name="address" placeholder="Customer address"></div>
        </div>
      </div>
      <div style="margin-top:1rem;display:flex;gap:.5rem;">
        <a href="/admin/orders" class="btn-admin" style="border:1px solid #999;color:#999;">Cancel</a>
        <button class="btn-admin" style="border-color:#10b981;color:#10b981;">Create</button>
      </div>
    </form>
    <datalist id="timeOptions">
      <% for (var h=0; h<24; h++) { %>
        <% for (var m=0; m<60; m+=30) { var hh = String(h).padStart(2,'0'); var mm = String(m).padStart(2,'0'); %>
          <option value="<%= hh %>:<%= mm %>"></option>
        <% } %>
      <% } %>
    </datalist>
  </main>
  <%- include('../partials/footer') %>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script>
    (function(){
      const dateOpts = { dateFormat: 'Y-m-d' };
      const timeOpts = { enableTime: true, noCalendar: true, time_24hr: true, dateFormat: 'H:i' };
      const q = (sel) => document.querySelector(sel);
      const el = (name) => q(`input[name="${name}"]`) || q(`select[name="${name}"]`);
      const pickupDateEl = el('pickupDate');
      const returnDateEl = el('returnDate');
      const pickupTimeEl = el('pickupTime');
      const returnTimeEl = el('returnTime');
      const pickupLocEl  = el('pickupLocation');
      const returnLocEl  = el('returnLocation');
      const rentalDaysEl = el('rentalDays');
      const deliveryEl   = el('deliveryPrice');
      const returnEl     = el('returnPrice');
      const totalEl      = el('totalPrice');
      const carEl        = el('carId');
      const submitBtn    = document.querySelector('button.btn-admin');

      flatpickr(pickupDateEl, dateOpts);
      flatpickr(returnDateEl, dateOpts);
      flatpickr(pickupTimeEl, timeOpts);
      flatpickr(returnTimeEl, timeOpts);

      const deliveryReturnPrices = {
        'office': 0,
        'sunny-beach': 25,
        'sveti-vlas': 30,
        'nesebar': 30,
        'burgas': 40,
        'burgas-airport': 50,
        'sofia': 100,
        'sofia-airport': 120,
        'varna': 80,
        'varna-airport': 90,
        'plovdiv': 70,
        'eleni': 35,
        'ravda': 20
      };

      function parseDateTime(dEl, tEl, fallbackTime) {
        const d = dEl && dEl.value ? dEl.value : '';
        const t = tEl && tEl.value ? tEl.value : fallbackTime;
        return new Date(`${d}T${t || '00:00'}:00Z`);
      }

      function calcDays() {
        const start = parseDateTime(pickupDateEl, pickupTimeEl, '00:00');
        const end   = parseDateTime(returnDateEl,  returnTimeEl,  '23:59');
        const msPerDay = 86400000;
        const days = Math.max(1, Math.floor((end - start) / msPerDay));
        rentalDaysEl.value = isFinite(days) ? days : 1;
      }

      function calcDeliveryReturn() {
        deliveryEl.value = deliveryReturnPrices[pickupLocEl.value] || 0;
        returnEl.value   = deliveryReturnPrices[returnLocEl.value] || 0;
      }

      function perDayFromOption(opt, days){
        if (!opt) return 0;
        const base = Number(opt.dataset.tier1_3 || opt.dataset.price || 0);
        const t7   = Number(opt.dataset.tier7_31 || 0);
        const t31  = Number(opt.dataset.tier31_plus || 0);
        if (days <= 3) return base;
        if (days <= 7) return t7 || base;
        if (days <= 31) return t7 || base;
        return t31 || t7 || base;
      }

      function calcTotal() {
        const days = Number(rentalDaysEl.value || '1');
        const opt = carEl.options[carEl.selectedIndex];
        const perDay = perDayFromOption(opt, days);
        const base = perDay * days;
        totalEl.value = (base + Number(deliveryEl.value||0) + Number(returnEl.value||0)).toFixed(2);
      }

      async function checkAvailability() {
        const carId = carEl.value;
        if(!carId || !pickupDateEl.value || !returnDateEl.value){
          // clear banner and enable button decision will be based on required inputs
          const node = document.querySelector('.banner.error.dynamic');
          if (node) node.remove();
          setSubmitDisabled(!carId);
          return;
        }
        try {
          const params = new URLSearchParams({
            pickupDate: pickupDateEl.value,
            pickupTime: pickupTimeEl.value,
            returnDate: returnDateEl.value,
            returnTime: returnTimeEl.value,
          });
          const res = await fetch(`/admin/cars/${carId}/availability?`+params.toString(), { headers: { 'Accept':'application/json' }});
          const data = await res.json();
          let node = document.querySelector('.banner.error.dynamic');
          if (data && data.ok && data.available) {
            if (node) node.remove();
            setSubmitDisabled(false);
          } else {
            if(!node){
              node = document.createElement('div');
              node.className = 'banner error dynamic';
              node.style.cssText = 'border:2px solid #ef4444;color:#ef4444;font-weight:800;padding:.6rem .8rem;border-radius:8px;margin:.5rem 0 1rem 0;background:rgba(239,68,68,.1)';
              const form = document.querySelector('form.card');
              form.parentNode.insertBefore(node, form);
            }
            const conflictText = (data && data.conflicts && data.conflicts.length)
              ? `Selected car is already booked in: ${data.conflicts.map(c=>`${c.startDate.slice(0,16).replace('T',' ')} â€“ ${c.endDate.slice(0,16).replace('T',' ')}`).join('; ')}`
              : 'Selected car is already booked in the specified period.';
            node.textContent = (data && data.error) ? data.error : conflictText;
            setSubmitDisabled(true);
          }
        } catch (_){}
      }

      function setSubmitDisabled(disabled){
        if (!submitBtn) return;
        submitBtn.disabled = !!disabled;
        submitBtn.style.opacity = disabled ? '.5' : '1';
        submitBtn.style.cursor = disabled ? 'not-allowed' : 'pointer';
      }

      function recompute(){
        calcDays();
        calcDeliveryReturn();
        calcTotal();
        checkAvailability();
      }

      ['change','input'].forEach(evt => {
        [pickupDateEl, returnDateEl, pickupTimeEl, returnTimeEl, pickupLocEl, returnLocEl, carEl].forEach(e => e.addEventListener(evt, recompute));
      });

      // initial compute
      setSubmitDisabled(!carEl.value);
      recompute();
    })();
  </script>
</body>
</html>


